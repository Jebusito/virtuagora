{# VARIBLES #}

{% extends "admin/ver-administracion.twig" %}

{# ----------------------------------------------------------- #}
{% block titulo %}Virtuagora - Verificar usuarios{% endblock %}
{# ----------------------------------------------------------- #}
{% block linkheads_cont %}{% endblock %}
{# ----------------------------------------------------------- #}
{% set intro_titulo = 'Verificar usuarios' %}
{# ----------------------------------------------------------- #}
{% block administracion %}
<div class="verificar-usuarios">
    <div class="listar-usuarios row">
        <div class="large-12 columns">
            <div class="titulo">
                <h4>Usuarios sin verificar</h4>
            </div>
            <hr>
            <div class="explicacion panel">
                En la siguiente tabla tiene la lista de usuarios que no están verificados. Para agregar un usuario a la lista de "Usuarios a verificar" haga clic en el boton con el icono <i class="fa fa-plus fa-fw"></i>
            </div>
            <dl class="sub-nav sort" role="menu" title="Filter Menu List">
                <dt><i class="fa fa-list-ol fa-fw fa-lg"></i> Ordenar: </dt>
                <dd class="sortNombre" role="menuitem" ><a href="javascript:sortNombre();"><i class="fa fa-sort-alpha-asc fa-fw"></i> Nombre</a></dd>
                <dd class="sortApellido" role="menuitem"><a href="javascript:sortApellido();"><i class="fa fa-sort-alpha-asc fa-fw"></i> Apellido</a></dd>
                <dd class="sortPuntos" role="menuitem"><a href="javascript:sortPuntos();"><i class="fa fa-sort-numeric-desc fa-fw"></i> Puntos</a></dd>
            </dl>
            <dl class="sub-nav ver" role="menu" title="Filter Menu List">
                <dt><i class="fa fa-filter fa-fw fa-lg"></i> Filtrar: </dt>
                <dd class="verTodo active" role="menuitem" ><a href="javascript:verTodo();"><i class="fa fa-eye fa-fw"></i> Todo</a></dd>
                <dd class="verAdvertidos" role="menuitem"><a href="javascript:verAdvertidos();"><i class="fa fa-warning fa-fw"></i> Advertidos</a></dd>
                <dd class="verSuspendidos" role="menuitem"><a href="javascript:verSuspendidos();"><i class="fa fa-times fa-fw"></i> Suspendidos</a></dd>
            </dl>
            <table class="tabla-usuarios">
                <thead>
                    <tr style="//display:none;">
                        <th class="text-center" style="display:none;">ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th class="text-center"><i class="fa fa-trophy fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-warning fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-times fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-cog fa-fw"></i></th>
                    </tr>
                </thead>
                <tbody class="usuarios">
                    <tr>
                        <td colspan=6 class="text-center"><i class="fa fa-spinner fa-pulse"></i> Buscando usuarios</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="listar-usuarios row">
        <div class="large-12 columns">
            <div class="titulo">
                <h4>Usuarios a verificar</h4>
            </div>
            <hr>
            <div class="explicacion panel">
                En la siguiente tabla se irán agregando los usuarios que usted eligió verificar de la lista anterior. Puede quitar usuarios de esta lista haciendo clic en el boton <i class="fa fa-minus fa-fw"></i>
            </div>
            <table class="tabla-usuarios-verificar">
                <thead>
                    <tr style="//display:none;">
                        <th class="text-center" style="display:none;">ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th class="text-center"><i class="fa fa-trophy fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-warning fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-times fa-fw"></i></th>
                        <th class="text-center"><i class="fa fa-cog fa-fw"></i></th>
                    </tr>
                </thead>
                <tbody class="agregando">

                </tbody>
            </table>
        </div>
    </div>
    <div class="row text-center">
        <form id="verificar" action="{{ urlFor('runAdmVrfUsuario') }}" method="POST">
            <input type="text" name="entrantes" style="display:none;">
            <button class="button radius success"><i class="fa fa-check fa-fw"></i> Verificar ciudadanos</button>
        </form>
    </div>
</div>

{% endblock %}
{# ----------------------------------------------------------- #}
{% block modals %}{% endblock %}
{# ----------------------------------------------------------- #}
{% block scripts_cont %}
<script src="{{ baseUrl() }}/assets/js/tablesorter/jquery.tablesorter.js"></script>
<script>
    var usuarios_verificar = new Array();

    $(document).ready(function(){
        $('.sub-nav').children('dd').hide();
        enviarSolicitud();
    });

    $(function() {
        // setTimeout() function will be fired after page is loaded
        // it will wait for 5 sec. and then will fire
        // $("#successMessage").hide() function
        setTimeout(function() {
            $(".ultima-fila").remove();
        }, 2000);
    });
    var agregarUsuario = function(id, nombre, apellido, puntos, advertencia, suspendido) {
        td_id = $('<td>').addClass('text-center').hide().html( id );
        td_nombre = $('<td>').html( nombre );
        td_apellido = $('<td>').html( apellido );
        td_puntos = $('<td>').addClass('text-center').html( puntos );
        td_advertencia = $('<td>').addClass('text-center').html( 'null' );
        td_suspendido = $('<td>').addClass('text-center').html( 'null' );
        boton_agregar = $('<a>').attr('src','#').addClass('agregar button tiny radius').html('<i class="fa fa-plus fa-fw fa-lg"></i>')
        td_agregar = $('<td>').addClass('text-center').html( boton_agregar );
        if( advertencia ){
            td_advertencia = td_advertencia.html( 'Si' );
        } else {
            td_advertencia = td_advertencia.html( 'No' );
        }
        if( suspendido ){
            td_suspendido = td_suspendido.html( 'Si' );
        } else {
            td_suspendido = td_suspendido.html( 'No' );
        }

        tr_usuario = $('<tr>')
            .append(td_id)
            .append(td_nombre)
            .append(td_apellido)
            .append(td_puntos)
            .append(td_advertencia)
            .append(td_suspendido)
            .append(td_agregar)
            .attr('id','usuario-'+id)
            .addClass('usuario');
        if( advertencia ){
            tr_usuario.addClass('advertido');
        }
        if( suspendido ){
            tr_usuario.addClass('suspendido');
        }


        $(".tabla-usuarios").find('tbody').append(tr_usuario);
    }
    var agregarUltimaFila = function(mensaje) {
        td_mensaje = $('<td>').addClass('text-center').attr('colspan',6).html( mensaje );
        tr_ultima = $('<tr>').addClass('ultima-fila').append(td_mensaje);
        $(".tabla-usuarios").find('tbody').append( tr_ultima );
    }
    var agregarErrorFila = function(mensaje) {
        td_mensaje = $('<td>').addClass('text-center').attr('colspan',6).html( mensaje );
        tr_ultima = $('<tr>').append(td_mensaje);
        $(".tabla-usuarios").find('tbody').append( tr_ultima );
    }

    var enviarSolicitud = function() {
        var request = $.ajax({
            url: '{{ baseUrl() }}/usuario',
            cache: false,
            dataType: "json"
        });
        request.done(function(resultados) {
            $(".tabla-usuarios").find('tbody').empty();
            for (var i=0; i<resultados.length; i++) {
                agregarUsuario(
                    resultados[i].id,
                    resultados[i].nombre,
                    resultados[i].apellido,
                    resultados[i].puntos,
                    resultados[i].advertencia,
                    resultados[i].suspendido);
            }
            agregarUltimaFila('<i class="fa fa-check fa-fw"></i> Fin de la busqueda de los usuarios');
            setTimeout(function() {
                $('.sub-nav').children('dd').show();
            }, 2000);
            return true;
        });
        request.fail(function(jqXHR, textStatus) {
            $(".tabla-usuarios").find('tbody').empty();
            alert("Request failed: " + textStatus);
            agregarErrorFila( '<i class="fa fa-unlink fa-fw"></i> Error en la busqueda de los usuarios!');
            return false;
        });
    }

    $(document).on('click', '.agregar', function() {
        $(this).removeClass('agregar').addClass('quitar');
        $(this).addClass('alert');
        $(this).children().removeClass('fa-plus').addClass('fa-minus');
        $('.agregando').append($(this).closest('.usuario'));
    });

    $(document).on('click', '.quitar', function() {
        verTodo();
        $(this).removeClass('quitar').addClass('agregar');
        $(this).removeClass('alert');
        $(this).children().removeClass('fa-minus').addClass('fa-plus');
        $('.usuarios').append($(this).closest('.usuario'));
    });

    $('#verificar').submit(function() {
        $('.agregando').children('tr').each(function () {
            var id_num = $(this).attr('id').replace('usuario-', '');
            alert(id_num);
            usuarios_verificar.push(id_num);
        });
        json_usuarios = JSON.stringify(usuarios_verificar);
        $('input[name="entrantes"]').val(json_usuarios);
        alert($('input[name="entrantes"]').val());
    });

    var sortNombre = function() {
        $('.sub-nav.sort dd.active').removeClass('active');
        $('.sortNombre').addClass('active');
        var sorting = [[0,1]];
        $('.tabla-usuarios').tablesorter();
        $('.tabla-usuarios').trigger("sorton",[sorting]);
    }
    var sortApellido = function() {
        $('.sub-nav.sort dd.active').removeClass('active');
        $('.sortApellido').addClass('active');
        var sorting = [[0,0]];
        $('.tabla-usuarios').tablesorter();
        $('.tabla-usuarios').trigger("sorton",[sorting]);
    }
    var sortPuntos = function() {
        $('.sub-nav.sort dd.active').removeClass('active');
        $('.sortPuntos').addClass('active');
        var sorting = [[2,0]];
        $('.tabla-usuarios').tablesorter();
        $('.tabla-usuarios').trigger("sorton",[sorting]);
    }
    var verTodo = function() {
        $('.sub-nav.ver dd.active').removeClass('active');
        $('.verTodo').addClass('active');
        $('.usuarios tr.usuario').show();
    }
    var verAdvertidos = function() {
        $('.sub-nav.ver dd.active').removeClass('active');
        $('.verAdvertidos').addClass('active');
        $('.usuarios tr.usuario').hide();
        $('.usuarios tr.advertido').show();
    }
    var verSuspendidos = function() {
        $('.sub-nav.ver dd.active').removeClass('active');
        $('.verSuspendidos').addClass('active');
        $('.usuarios tr.usuario').hide();
        $('.usuarios tr.suspendido').show();
    }


</script>
{% endblock %}
{# ----------------------------------------------------------- #}
